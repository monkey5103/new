<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>後台管理系統</title>
  <script>
    // 檢查登入狀態，未登入則導回登入頁面
    if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
      window.location.href = 'login.html';
    }
  </script>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: auto; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { text-align: center; }
    td { text-align: left; }
    td.price { text-align: right; }
    input, select { padding: 5px; }
    button { padding: 8px 12px; margin: 5px; }
    .in-stock { color: green; font-weight: bold; }
    .out-stock { color: gray; font-weight: bold; }
    .hot-stock { color: red; font-weight: bold; }
    .upload-section { margin-top: 20px; background: #f1f1f1; padding: 10px; border-radius: 6px; }
  </style>
</head>
<body>

<h1>📦 後台藥品管理 (資料同步前台)</h1>

<div>
  <label>分類：</label>
  <select id="categorySelect">
    <option value="products">一般藥品</option>
    <option value="specialProducts">壯陽/避孕/無健保藥物</option>
    <option value="coldProducts">冷品</option>
  </select>
  <button onclick="loadCategory()">載入</button>
</div>

<table>
  <thead>
    <tr>
      <th>健保碼</th>
      <th>藥品名稱</th>
      <th>規格</th>
      <th>優惠價</th>
      <th>庫存狀態</th>
      <th>刪除</th>
    </tr>
  </thead>
  <tbody id="adminTableBody"></tbody>
</table>

<div>
  <h3>新增藥品</h3>
  <input id="nhicode" placeholder="健保碼">
  <input id="medname" placeholder="藥品名稱">
  <input id="spec" placeholder="規格">
  <input id="price" type="number" placeholder="優惠價">
  <select id="stock">
    <option value="供貨中">供貨中</option>
    <option value="缺貨中">缺貨中</option>
    <option value="熱門🔥">熱門🔥</option>
  </select>
  <button onclick="saveItem()">儲存</button>
</div>

<div class="upload-section">
  <h3>批量上傳 CSV</h3>
  <input type="file" id="fileInput" accept=".csv">
  <button onclick="importCSV()">匯入</button>
  <p>📥 <a href="sample_utf8_bom.csv" download>下載範例檔案</a></p>
</div>

<script>
  let data = JSON.parse(localStorage.getItem('drugData')) || {
    products: [],
    specialProducts: [],
    coldProducts: []
  };

  let currentCategory = 'products';

  function renderAdminTable(list) {
    const tableBody = document.getElementById('adminTableBody');
    tableBody.innerHTML = '';
    list.forEach((p, i) => {
      let stockClass = 'in-stock';
      if (p.stock.includes('缺貨')) stockClass = 'out-stock';
      else if (p.stock.includes('熱門')) stockClass = 'hot-stock';
      const row = document.createElement('tr');
      row.innerHTML = `
        <td contenteditable="true" oninput="updateField(${i}, 'nhicode', this.innerText)">${p.nhicode}</td>
        <td contenteditable="true" oninput="updateField(${i}, 'medname', this.innerText)">${p.medname}</td>
        <td contenteditable="true" oninput="updateField(${i}, 'spec', this.innerText)">${p.spec}</td>
        <td contenteditable="true" class="price" oninput="updateField(${i}, 'price', this.innerText)">${p.price}</td>
        <td contenteditable="true" oninput="updateField(${i}, 'stock', this.innerText)" class="${stockClass}">${p.stock}</td>
        <td><button onclick="deleteItem(${i})">刪除</button></td>
      `;
      tableBody.appendChild(row);
    });
    saveData();
  }

  function loadCategory() {
    currentCategory = document.getElementById('categorySelect').value;
    renderAdminTable(data[currentCategory]);
  }

  function saveItem() {
    const item = {
      nhicode: document.getElementById('nhicode').value,
      medname: document.getElementById('medname').value,
      spec: document.getElementById('spec').value,
      price: parseFloat(document.getElementById('price').value),
      stock: document.getElementById('stock').value
    };
    data[currentCategory].push(item);
    renderAdminTable(data[currentCategory]);
    clearForm();
  }

  function updateField(index, field, value) {
    if (field === 'price') {
      value = parseFloat(value) || 0;
    }
    data[currentCategory][index][field] = value;
    saveData();
  }

  function deleteItem(index) {
    data[currentCategory].splice(index, 1);
    renderAdminTable(data[currentCategory]);
  }

  function clearForm() {
    document.getElementById('nhicode').value = '';
    document.getElementById('medname').value = '';
    document.getElementById('spec').value = '';
    document.getElementById('price').value = '';
    document.getElementById('stock').value = '供貨中';
  }

  function saveData() {
    localStorage.setItem('drugData', JSON.stringify(data));
  }

  function importCSV() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return alert('請選擇 CSV 檔案');

    const reader = new FileReader();
    reader.onload = function(e) {
      const lines = e.target.result.split('\n').slice(1); // 去除標題
      lines.forEach(line => {
        const cols = line.split(',');
        if (cols.length >= 5) {
          data[currentCategory].push({
            nhicode: cols[0],
            medname: cols[1],
            spec: cols[2],
            price: parseFloat(cols[3]),
            stock: cols[4]
          });
        }
      });
      saveData();
      renderAdminTable(data[currentCategory]);
      alert('批量上傳完成！');
    };
    reader.readAsText(file, 'utf-8');
  }

  window.onload = loadCategory;
</script>

</body>
</html>
